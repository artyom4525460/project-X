(()=>{"use strict";function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var t=function(){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),window.AudioContext=window.AudioContext||window.webkitAudioContext,this.em=document.createDocumentFragment(),this.state="inactive",this.chunks=[],this.chunkType="",this.encoderMimeType="audio/wav",this.config={manualEncoderId:"wav",micGain:1,processorBufferSize:2048,stopTracksAndCloseCtxWhenFinished:!0,usingMediaRecorder:void 0!==window.MediaRecorder,userMediaConstraints:{audio:{echoCancellation:!1}}}}var i,n,o;return i=t,(n=[{key:"startRecording",value:function(){var e=this;if("inactive"===this.state){if(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)return this.audioCtx=new AudioContext,this.micGainNode=this.audioCtx.createGain(),this.outputGainNode=this.audioCtx.createGain(),this.config.usingMediaRecorder||(this.processorNode=this.audioCtx.createScriptProcessor(this.config.processorBufferSize,1,1)),this.audioCtx.createMediaStreamDestination?this.destinationNode=this.audioCtx.createMediaStreamDestination():this.destinationNode=this.audioCtx.destination,this.config.usingMediaRecorder||(this.encoderWorker=new Worker("./encoder-wav-worker.js"),this.encoderMimeType="audio/wav",this.encoderWorker.addEventListener("message",(function(t){var i=new Event("dataavailable");i.data=new Blob(t.data,{type:e.encoderMimeType}),e._onDataAvailable(i)}))),navigator.mediaDevices.getUserMedia(this.config.userMediaConstraints).then((function(t){e._startRecordingWithStream(t)})).catch((function(e){alert("Error with getUserMedia: "+e.message),console.log(e)}));alert("Missing support for navigator.mediaDevices.getUserMedia")}}},{key:"_startRecordingWithStream",value:function(e){var t=this;this.micAudioStream=e,this.inputStreamNode=this.audioCtx.createMediaStreamSource(this.micAudioStream),this.audioCtx=this.inputStreamNode.context,this.onGraphSetupWithInputStream&&this.onGraphSetupWithInputStream(this.inputStreamNode),this.inputStreamNode.connect(this.micGainNode),this.micGainNode.gain.setValueAtTime(this.config.micGain,this.audioCtx.currentTime);var i=this.micGainNode;this.state="recording",this.processorNode?(i.connect(this.processorNode),this.processorNode.connect(this.outputGainNode),this.processorNode.onaudioprocess=function(e){return t._onAudioProcess(e)}):i.connect(this.outputGainNode),this.outputGainNode.connect(this.destinationNode),this.config.usingMediaRecorder?(this.mediaRecorder=new MediaRecorder(this.destinationNode.stream),this.mediaRecorder.addEventListener("dataavailable",(function(e){return t._onDataAvailable(e)})),this.mediaRecorder.addEventListener("error",(function(e){return t._onError(e)})),this.mediaRecorder.start()):this.outputGainNode.gain.setValueAtTime(0,this.audioCtx.currentTime)}},{key:"_onAudioProcess",value:function(e){this.config.broadcastAudioProcessEvents&&this.em.dispatchEvent(new CustomEvent("onaudioprocess",{detail:{inputBuffer:e.inputBuffer,outputBuffer:e.outputBuffer}})),this.config.usingMediaRecorder||"recording"===this.state&&(this.config.broadcastAudioProcessEvents?this.encoderWorker.postMessage(["encode",e.outputBuffer.getChannelData(0)]):this.encoderWorker.postMessage(["encode",e.inputBuffer.getChannelData(0)]))}},{key:"stopRecording",value:function(){"inactive"!==this.state&&(this.config.usingMediaRecorder?(this.state="inactive",this.mediaRecorder.stop()):(this.state="inactive",this.encoderWorker.postMessage(["dump",this.audioCtx.sampleRate])))}},{key:"_onDataAvailable",value:function(e){if(this.chunks.push(e.data),this.chunkType=e.data.type,"inactive"===this.state){var t=new Blob(this.chunks,{type:"audio/wav"}),i=URL.createObjectURL(t),n={ts:(new Date).getTime(),blobUrl:i,mimeType:t.type,size:t.size},o=new window.FileReader;o.readAsDataURL(t),o.onloadend=function(){var e=o.result;n.blob=e},this.chunks=[],this.chunkType=null,this.destinationNode&&(this.destinationNode.disconnect(),this.destinationNode=null),this.outputGainNode&&(this.outputGainNode.disconnect(),this.outputGainNode=null),this.processorNode&&(this.processorNode.disconnect(),this.processorNode=null),this.encoderWorker&&(this.encoderWorker.postMessage(["close"]),this.encoderWorker=null),this.micGainNode&&(this.micGainNode.disconnect(),this.micGainNode=null),this.inputStreamNode&&(this.inputStreamNode.disconnect(),this.inputStreamNode=null),this.config.stopTracksAndCloseCtxWhenFinished&&(this.micAudioStream.getTracks().forEach((function(e){return e.stop()})),this.micAudioStream=null,this.audioCtx.close(),this.audioCtx=null),this.em.dispatchEvent(new CustomEvent("recording",{detail:{recording:n}}))}}},{key:"_onError",value:function(e){console.log("error",e),this.em.dispatchEvent(new Event("error"))}}])&&e(i.prototype,n),o&&e(i,o),t}();function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.btnRecord=document.getElementById("btn-record"),this.btnStop=document.getElementById("btn-stop"),this.debugTxt=document.getElementById("cander-recording-debug-txt"),this.recordingsCont=document.getElementById("recordings-cont"),this.isRecording=!1,this.debugTxt.innerHTML="stopped",this.timeout=null,this.time="00:00"}var n,o,r;return n=e,(o=[{key:"init",value:function(){this._initEventListeners()}},{key:"_initEventListeners",value:function(){var e=this;this.btnRecord.addEventListener("click",(function(t){e._stopAllRecording(),e._startRecording(),e.btnRecord.disabled=!0,e.btnStop.disabled=!1,e.debugTxt.innerHTML="recording"})),this.btnStop.addEventListener("click",(function(t){e._stopAllRecording(),e.btnRecord.disabled=!1,e.btnStop.disabled=!0,e.debugTxt.innerHTML="stopped"}))}},{key:"_startRecording",value:function(){var e=this;this.recorderSrvc=new t,this.recorderSrvc.em.addEventListener("recording",(function(t){return e._onNewRecording(t)})),this.recorderSrvc.startRecording(),this.isRecording=!0,this.debugTxt.innerHTML="recording..."}},{key:"_stopAllRecording",value:function(){this.recorderSrvc&&this.isRecording&&(this.recorderSrvc.stopRecording(),this.isRecording=!1)}},{key:"_onNewRecording",value:function(e){var t=this;setTimeout((function(){t.recordingsCont.childNodes.length;var i=document.createElement("div");i.innerHTML='<audio id="audio-recording" controls></audio>',t.recordingsCont.appendChild(i);var n=document.getElementById("audio-recording");console.log(e.detail.recording),console.log(e.detail.recording.blob),console.log(e.detail.recording.blobUrl),n.src=e.detail.recording.blob,n.type=e.detail.recording.mimeType}),1e3)}}])&&i(n.prototype,o),r&&i(n,r),e}();window.onload=function(e){(new n).init()}})();